#!/bin/bash

# Resolve directory of the script to find libs
SCRIPT_SRC_DIR="$(cd "$(dirname "$0")" && pwd)"
LIB_DIR="$SCRIPT_SRC_DIR/lib"

# If not found in relative path (e.g. installed in a bin directory), try relative to prefix or system paths
if [ ! -d "$LIB_DIR" ]; then
    # Try relative to prefix: ../lib/clickup-cli
    RELATIVE_LIB_DIR="$(cd "$SCRIPT_SRC_DIR/../lib/clickup-cli" 2>/dev/null && pwd)"
    if [ -d "$RELATIVE_LIB_DIR" ]; then
        LIB_DIR="$RELATIVE_LIB_DIR"
    elif [ -d "$HOME/.local/lib/clickup-cli" ]; then
        LIB_DIR="$HOME/.local/lib/clickup-cli"
    elif [ -d "/usr/local/lib/clickup-cli" ]; then
        LIB_DIR="/usr/local/lib/clickup-cli"
    else
        echo "Error: Could not find library directory at $LIB_DIR or standard system paths" >&2
        exit 1
    fi
fi

# Load all libraries
. "$LIB_DIR/config.sh"
. "$LIB_DIR/logger.sh"
. "$LIB_DIR/api.sh"
. "$LIB_DIR/help.sh"
. "$LIB_DIR/cmd_chat.sh"
. "$LIB_DIR/cmd_tasks.sh"
. "$LIB_DIR/cmd_hierarchy.sh"

createClickupCliFolderIfNeeded
loadConfig

BASE_URL="${BASE_URL:-https://api.clickup.com/api/v3}"
API_TOKEN="${API_TOKEN}"
WORKSPACE_ID="${DEFAULT_WORKSPACE_ID}"
CHANNEL_ID="${DEFAULT_CHANNEL_ID}"
VERBOSE=0
VERSION="0.1.0"

if ! isJQAvailable; then
    echo "Warning: 'jq' is not installed. JSON parsing will rely on basic text processing, which may be fragile." >&2
fi

# Parse command-line arguments with support for flags and subcommands
parseArguments() {
    if [ "$#" -lt 1 ]; then
        showUsage
        exit 1
    fi

    # Parse global flags first
    while [ $# -gt 0 ]; do
        case "$1" in
            -h|--help)
                showUsage
                exit 0
                ;;
            --version)
                echo "clickup-cli version $VERSION"
                exit 0
                ;;
            -w|--workspace)
                if [ -z "$2" ]; then
                    log "Error: --workspace requires a value"
                    exit 1
                fi
                WORKSPACE_ID="$2"
                shift 2
                ;;
            -c|--channel)
                if [ -z "$2" ]; then
                    log "Error: --channel requires a value"
                    exit 1
                fi
                CHANNEL_ID="$2"
                shift 2
                ;;
            -v|--verbose)
                VERBOSE=1
                shift
                ;;
            -*)
                log "Error: Unknown option $1"
                showUsage
                exit 1
                ;;
            *)
                # First non-flag argument is the command
                break
                ;;
        esac
    done

    if [ $# -lt 1 ]; then
        log "Error: No command specified"
        showUsage
        exit 1
    fi

    # Dispatch to subcommand handlers
    local command="$1"
    shift
    
    case "$command" in
        send)
            handleSendCommand "$@"
            ;;
        list)
            handleListCommand "$@"
            ;;
        create)
            handleCreateCommand "$@"
            ;;
        update)
            handleUpdateCommand "$@"
            ;;
        delete)
            handleDeleteCommand "$@"
            ;;
        show)
            handleShowCommand "$@"
            ;;
        configure)
            handleConfigureCommand "$@"
            ;;
        help)
            showUsage
            exit 0
            ;;
        *)
            log "Error: Unknown command '$command'"
            showUsage
            exit 1
            ;;
    esac
}

# Handle 'configure' command
handleConfigureCommand() {
    interactiveConfigure
}

parseArguments "$@"